Правим news feed система. На кратко какво представлява фиид-а - Общо казано, това е актуален списък с новини, статуси, снимки, клипове, дейстивия и други, свързани с хора и организации към които имаш интерес.

Имаме за задача да изградим такава система. Тя трябва да поддържа клиенти от различни видове (уеб и мобилен). Всеки потребител има право на до 5000 приятели/последователи. Трябва да поддържаме до 10 милиона DAU. Функционалностите ще са ограничени - Всеки потребител може да качва пост, който може да съдържа и медиини файлове, и който нашата система трябва да сподели във фиид-а на неговите приятели.

Нека да направим един BOE анализ на проблема, няма го в книгата, но мисля, че за това са ни дали тези данни.
- Ако имаме 10М DAU и всеки качва по два поста на ден средно имаме 20М поста или **231 поста в секунда**
- За да преценим колко памет ни трябва можем да предположим, че един тесктов пост е 500KB, една снимка е 1MB и едно видео е 5MB. Отново предполагаме, че имаме 20М поста с текст, 10М със снимка и 2М с видео. Тоест **20М х 500KB + 10М х 1MB + 2М х 5MB = 20TB/day**
- Ако всеки потребител има 5000 приятели и качва по 2 поста на ден, тогава ние ще трябва да преработваме **10М х 5000 х 2 = 100B фиид актуализации на ден или 1.1М на секунда**
Общо взето говорим за солидна система, която изисква много добро обмисляне и мъдро използване на ресурси.

Така знаем какво правим и какво може да ни коства, така че можем да започнем с един дизнайн на високо ниво. Очевидно ни трябва API, към което да се пращат заявки за създаване на постове и за получване на фиид-ове. Апито ще има два основни еднпойнта POST /feed & GET /feed като пост заявката трябва да приема body или параметри за поста и съответно трябва да предоставя механизъм за аутентикация и за запазване и fanout на поста, от своя страна гет рекуеста трябва да има механизъм за аутентикация и да предоставя фиид-а на съответният потребител.

В книгата не се споменава експилцитно, но най-вероятно ще имаме microservice архитектура или поне доста самостоятелни компоненти, нека да направим разбивка на отделните части на системата.
- Клиент - Браузът или телефон, който праща завки
- Load Balancer - Препраща заявките към свободните уеб сървъри
- Web Servers - Това е нашият дистрибутиран сървър, говорим за множество инстанции за да издържат на натоварването, потенциално в различни дата центрове, също така бихме използвали отделни инстанции за известни личности и хора с много последователи. Web Server-ите също така ще отговарят за аутентикация, ауторизация, load balancing, потенциално събиране на метрики и др.
- Post Service - Този service ще се използва от сървърите и ще има за задача да запазва постовете в нашата база данни (най-вероятно и тук ще имаме хоризонтално скалиране) и кеша.
- Fanout Service - Като за начало нека да споменем двете основни техники за фанаут на постовете или "разпръскването" на постовете към приятелите на съответният потребител, който е създал поста. Имаме пуш похват, където постовете се fanout-ват повреме на записване, тоест щом потребител си качи поста, фиид-овете на приятелите му се ъпдейтват веднага, това води до по-бързо фечване на фиид-овете понеже те са вече генерирани, но има и недостатъци като излишен разход на ресурси за неактивни потребители и така нареченият hotkey проблем където потребители с много приятели изразходват прекалено много ресурс за fanout. Вторият похват е така нареченият пул или фиид-а на един потребител се генерира on demand, тоест когато потребителя си поиска фиид-а ние взимаме последните постове и му ги предоставяме. Ние съответно ще използваме хибирден подход където за потребителите с повече приятели ще използваме пул метода, а за останалите пуш.
- Notification Service - Не се коментира особено в тази глава, но може да се направи рефернция към миналата.

Така един примерен обход на процеса, като ще добавя още няколко компонента:
1. Потребител изпраща заявка за създаване на пост
2. Заявката се препраща на сървър, чрез load balancer
3. Сървърът аутентикира и проверява дали няма наложен rate limit 
4. Post Service-а запазва поста в базата и в кеша
5. Fanout Service-а взима приятелите на потребителя от Graph база данни, след това взима информацията за всеки приятел с цел да проверим какви са преференциите им (ако например са mute-нали потребителя или потребителя гу е рестриктнал ги филтрираме от списъка). Веднъж щом имаме спъсъка с потрбители, чиито фиид трябва да бъде ъпдейтнат най-вероятно ще го подадем на message queue, което да заеме worker-и с fanout процеса. Фиида ще е във формата на кеш, който изглежда така postId:userId, не можем да пазим целият пост в кеш за това само го държим като референция.
За получаване на фиида:
1. Потребител изпраща заявка за получаване на фиид
2. Ако медиините файлове за запазени в CDN, те се пращат от там, в противен случай от сървъра, като се запазват и в CDN-a
3. Заявката се препраща на сървър, чрез load balancer
4. Сървърът аутентикира и проверява дали няма наложен rate limit
5. Проверя се фиид кеш-а като се взимат всички запазени postID-та
6. Постовете се изграждат като за това се използва user cache/db за информацията за създателя на поста и post cache/db за самото съдържание.
7. Фиид-а се изпраща в JSON формат

В тази система и много важно да взимаме и добри решения относно кеш-а ни, трябва ни кеш за фиид-а, за самото съдържание на посто-вете, за връзките между потребителите, за различни дейстия, които се случват като харесвания, споделяния и т.н., трябват ни броячи за лайкове, приятели, коментари и т.н.